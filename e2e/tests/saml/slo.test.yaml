---
name: SAML SLO
focus: true
authgear.yaml:
  override: |
    saml:
      signing:
        key_id: "-jeTn3EEV5bJUOMDQU04zLlkWFZK3BDODkfh40FX8K0"
      service_providers:
        - client_id: e2e
          nameid_format: urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified
          nameid_attribute_pointer: /preferred_username
          acs_urls:
            - https://samlsp.localhost/acs
          slo_enabled: true
          slo_callback_url: https://samlsp.localhost/slo
          slo_binding: urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST
before:
  - type: user_import
    user_import: users.json
  - type: create_session
    create_session:
      session_type: idp
      session_id: e2e-idp-session-1
      token: e2eidpsessiontoken1
      select_user_id_sql: |
        SELECT id FROM _auth_user u
          WHERE u.app_id = '{{ .AppID }}' AND
          u.standard_attributes ->> 'preferred_username' = 'samltest01';
steps:
  # Send a valid saml logout request to the logout endpoint
  # Expect:
  #  1. The server should be able to parse the request
  #  2. Return a valid logout response
  - action: "saml_request"
    # Note: SessionIndex is computed by encoding idp:e2e-idp-session-1 with base64 url
    # This is same as the encoding of sid in oidc
    saml_request: |
      <samlp:LogoutRequest
        xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
        xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
        ID="logoutrequest_00000001"
        Version="2.0"
        IssueInstant="3014-07-18T01:13:06Z">
        <saml:Issuer>urn:e2e.localhost</saml:Issuer>
        <saml:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:unspecified"
        >samltest01</saml:NameID>
        <samlp:SessionIndex>aWRwOmUyZS1pZHAtc2Vzc2lvbi0x</samlp:SessionIndex>
      </samlp:LogoutRequest>
    saml_request_destination: "/saml2/logout/e2e"
    saml_request_binding: urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect
    saml_output:
      http_status: 200
      saml_response:
        binding: urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST
        match: |
          <samlp:LogoutResponse
            xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
            xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
            InResponseTo="logoutrequest_00000001"
            Version="2.0"
            Destination="https://samlsp.localhost/slo"
            >
            <saml:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity"/>
            <ds:Signature/>
            <samlp:Status>
              <samlp:StatusCode
                Value="urn:oasis:names:tc:SAML:2.0:status:Success" />
              </samlp:Status>
          </samlp:LogoutResponse>

