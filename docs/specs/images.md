# Authgear Images

Authgear Images server provides images storing and resizing for user profile attributes.

## Endpoints

### Serving image

The serving image endpoint obtains the images from the object store, performs resizing, and serves the image directly.

The serving image endpoint is publicly accessible.

```
GET /_images/APP_ID/OBJECT_ID/OPTIONS HTTP/1.1
```

- `APP_ID`: The authgear app id
- `OBJECT_ID`: The file object id
- `OPTIONS`: Following options are supported.
    - Resizing options, e.g. `w=400,h=300`
    - Resizing profile, a pre-configured resizing option, e.g. `profile`
    - Original image: `original`

### Uploading image

The uploading endpoint stores the image to the object store and creates records in the database for future reference.

The uploading image endpoint is a signed URL generated by the Authgear main server and admin server to upload the user profile image.

```
POST /_images/APP_ID/OBJECT_ID?metadata=METADATA_JSON&signature=SIGNATURE HTTP/1.1
Content-Type: THE_IMAGE_CONTENT_TYPE

THE FILE CONTENT

---
HTTP/1.1 200 OK
Content-Type: application/json

{ "variants": { "original": "ORIGINAL_IMAGE_URL", "profile": "PROFILE_IMAGE_URL" } }
```

- `APP_ID`: The authgear app id
- `OBJECT_ID`: The file object id
- `METADATA_JSON`: The metadata contains the user id and is stored in the database. The user id is provided by the Authgear main server and admin server.
- `SIGNATURE`: The URL signature.

## Object store

[MinIO](https://min.io/) is used as the object store.

## Integrations

### Auth UI

When the user uploads the profile image from the Auth UI.
1. The Auth UI frontend sends a request to the main server and obtains the pre-signed upload URL.
1. The Auth UI frontend uploads the image to the pre-signed upload URL.
1. The Auth UI frontend obtains the image variants from the Authgear Images server and sets the profile URL to the user profile attributes.

#### Request signed upload URL endpoint

The endpoint is rate-limited per user.

```
POST /images/upload HTTP/1.1

---
HTTP/1.1 200 OK
Content-Type: application/json

{ "upload_url": "SIGNED_URL" }
```

### Admin API

The Admin API will also be used by the portal for updating user profile images.

The user profile image uploading flow:
1. Call the API to obtain the pre-signed upload URL.
2. Upload the image to the pre-signed upload URL and obtain the variants.
3. Set the profile image URL to the user profile attributes through admin GraphQL API.

#### Request signed upload URL endpoint

```
POST /_api/admin/images/upload HTTP/1.1
Content-Type: application/json

{ "user_id": "USER_ID" }

---
HTTP/1.1 200 OK
Content-Type: application/json

{ "upload_url": "SIGNED_URL" }
```

## Database table schema

```sql
CREATE TABLE _images_file
(
    id         text  PRIMARY KEY,
    app_id     text  NOT NULL,
    object_id  text  NOT NULL,
    size       int   NOT NULL,
    metadata   jsonb NOT NULL,
    created_at timestamp without time zone NOT NULL,
);
```
